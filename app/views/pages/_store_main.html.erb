<div class="pt-0 px-3 p-md-4 position-relative store-main-wrap">

  <!-- Мобильный заголовок + кнопки -->
  <div class="d-flex d-lg-none justify-content-between align-items-center mb-2 mobile-header glass-panel">
    <h1 class="h5 mb-0" id="mobile-sticky-header-text">Store</h1>
    <div class="d-flex align-items-center gap-2">
      <button
        class="btn btn-light p-1"
        type="button"
        data-bs-toggle="offcanvas"
        data-bs-target="#storeOffcanvasNav"
        aria-controls="storeOffcanvasNav"
        aria-label="Open store filters and categories">
        <i class="bi bi-sliders2-vertical fs-4"></i>
      </button>
    </div>
  </div>

  <!-- Центрированный хедер для десктопа -->
  <div class="sticky-main-header text-center mb-4 d-none d-lg-block py-3">
    <h1 class="fw-light" id="center-header-content">
      <span id="sticky-header-text">
        iLab <span class="text-muted"><strong>Store</strong></span>
        <% if @family.present? %>
          <span class="badge bg-dark-subtle text-dark align-middle ms-2"><%= @family %></span>
        <% end %>
      </span>
    </h1>
    <small class="text-muted">Browse our collection of certified pre-owned Apple devices.</small>
    <div class="mt-3">
      <%= link_to "Выставить на продажу", new_product_path, class: "btn btn-success" %>
    </div>
  </div>

  <% if @products_by_category.blank? %>
    <div class="alert alert-info my-3">
      <% if @family.present? %>
        В этом семействе нет товаров.
        <%= link_to 'Показать все товары', store_path, class: 'ms-2' %>
      <% else %>
        Пока нет товаров для отображения.
      <% end %>
    </div>
  <% end %>

  <% @products_by_category.each do |category, products| %>
    <% next if category.nil? || products.blank? %>

    <% heading =
         if category.respond_to?(:heading) && category.heading.present?
           category.heading
         elsif category.respond_to?(:title)
           category.title
         else
           'Без категории'
         end
    %>

    <h3 id="<%= dom_id(category) %>" class="category-heading mb-3 text-center text-muted shadow-sm pb-2"><%= heading %></h3>

    <div class="row row-cols-1 row-cols-md-2 g-4 mt-1">
      <% products.each do |product| %>
        <div class="col" id="product-<%= product.id %>">
          <div class="card h-100 shadow-sm">
            <% if product.respond_to?(:avatar) && product.avatar.present? %>
              <%= image_tag product.avatar.url, class: "card-img-top", alt: product.name %>
            <% end %>

            <div class="card-body d-flex flex-column">
              <h5 class="card-title word-break"><%= product.name %></h5>
              <p class="card-text text-muted flex-grow-1"><%= truncate(product.description.to_s, length: 80) %></p>
              <p class="fs-5 fw-bold text-end">$<%= product.price %></p>
            </div>

            <div class="card-footer bg-transparent border-top-0">
              <%= form_with model: @order_item, url: order_items_path do |f| %>
                <%= f.hidden_field :product_id, value: product.id %>
                <div class="input-group">
                  <%= f.number_field :quantity, value: 1, min: 1, class: 'form-control' %>
                  <%= f.submit "Add to Cart", class: "btn btn-primary" %>
                </div>
              <% end %>

              <!-- Mobile: turbo_stream + модалка -->
              <%= link_to "Details",
                          product_description_product_path(product, format: :turbo_stream),
                          data: { turbo_prefetch: "false" },
                          class: "btn btn-sm btn-success d-lg-none mt-2" %>

              <!-- Desktop: правый сайдбар -->
              <%= link_to "Details",
                          product_description_product_path(product, format: :turbo_stream),
                          data: { turbo_frame: "product_details_frame", turbo_prefetch: "false" },
                          class: "btn btn-sm btn-outline-primary mt-2 d-none d-lg-block" %>
            </div>
          </div>
        </div>
      <% end %>
    </div>

    <!-- Здесь позже можно добавить кнопку "Показать ещё" под секцией -->
    <!-- <button class="btn btn-outline-dark mt-3">Показать ещё</button> -->
  <% end %>
</div>
